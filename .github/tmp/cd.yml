name: Frontend CD (v. 1.0)

on:
  pull_request:
    types: [closed]
    branches:
      - dev
  # push:
  #   branches:
  #     - infra/cicd

jobs:
  deploy-dev:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ SSH ì„¤ì •
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts

      # 2ï¸âƒ£ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
      - name: Deploy Frontend to Dev Server
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.DEV_SERVER_HOST }} 'bash -s' <<'EOF'
          set -e

          echo "ğŸš€ Frontend Deploy Start"

          cd /home/ubuntu/mine/frontend/4-team-IMYME-fe

          echo "ğŸ“¥ Git sync"
          git fetch origin 
          git reset --hard origin/dev

          echo "ğŸ“¦ Install pnpm & deps"
          pnpm install

          echo "ğŸ— Build"
          pnpm next build

          echo "ğŸ“ Ensure deploy directory"
          sudo mkdir -p /var/www/frontend
          sudo chown -R ubuntu:ubuntu /var/www/frontend


          echo "ğŸ§¹ Clean old build"
          rm -rf /var/www/frontend/*

          echo "ğŸ“¤ Deploy build artifacts"
          cp -r .next /var/www/frontend/.next
          cp package.json /var/www/frontend/

          echo "ğŸ” Restart frontend (if using pm2)"
          pm2 delete frontend || true
          pm2 start npx --name frontend -- next start -p 3000


          echo "ğŸ‰ Frontend Deploy Finished"
          EOF

  # ========================================
  # ì„±ê³µ ì•Œë¦¼
  # ========================================
  notify-success:
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: success()
    steps:
      - name: Discord notification on success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: 'ğŸŸ¢ Frontend Deploy Success'
          content: 'í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì„œë²„ ë°°í¬ ì™„ë£Œ!'
          description: |
            **Branch:** dev
            **Commit:** ${{ github.sha }}
            **ì„œë²„:** Dev Frontend
          color: 0x00ff00

  # ========================================
  # ì‹¤íŒ¨ ì•Œë¦¼
  # ========================================
  notify-failure:
    runs-on: ubuntu-latest
    needs: deploy-dev
    if: failure()
    steps:
      - name: Discord notification on failure
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: 'ğŸ”´ Frontend Deploy Failed'
          content: '<@&${{ secrets.FRONTEND_ROLE_ID }}> í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹¤íŒ¨!'
          description: |
            **Branch:** dev
            **Commit:** ${{ github.sha }}
            **ì—ëŸ¬ ë¡œê·¸:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          color: 0xff0000
