name: Frontend CI

on:
  push:
    branches: [main, develop, infra/cicd]
  pull_request:
    branches: [main, develop]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # pnpm ì˜ì¡´ì„± ìºì‹± - ë¹Œë“œ ì†ë„ í–¥ìƒìš©
      - name: Cache pnpm
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install

      # ========================================
      # ì •ì  ë¶„ì„ (Static Analysis)
      # ========================================

      # ESLint (ì½”ë“œ í’ˆì§ˆ + ì•ˆ ì“°ëŠ” ì½”ë“œ + í•˜ë“œì½”ë”© ì²´í¬)
      - name: Run ESLint
        run: pnpm lint

      # Prettier (ì½”ë“œ ìŠ¤íƒ€ì¼ - ë“¤ì—¬ì“°ê¸°, ì¤„ë°”ê¿ˆ)
      - name: Run Prettier
        run: pnpm prettier --check .

      # ========================================
      # íƒ€ì… ì²´í¬ (Type Check)
      # ========================================
      - name: Type Check
        run: pnpm tsc --noEmit

      # ========================================
      # ë¹Œë“œ (Build)
      # ========================================
      - name: Build
        run: pnpm next build

      # ========================================
      # ì•„í‹°íŒ©íŠ¸ ì €ì¥ (main ë¸Œëœì¹˜ë§Œ)
      # ========================================

      # ì´ì „ ì•„í‹°íŒ©íŠ¸ ì‚­ì œ
      - name: Delete old artifacts
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name === 'frontend-latest') {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
            }

      # ë¹Œë“œ ê²°ê³¼ ì €ì¥
      - name: Upload artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-latest
          path: .next/
          retention-days: 90
          overwrite: true

  # ========================================
  # ì‹¤íŒ¨ ì•Œë¦¼ (Discord)
  # ========================================
  notify-failure:
    runs-on: ubuntu-latest
    needs: ci
    if: failure()
    steps:
      - name: Discord notification on failure
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          content: '<@&${{ secrets.FRONTEND_ROLE_ID }}> í”„ë¡ íŠ¸ì—”ë“œ CI ì‹¤íŒ¨!'
          title: 'ğŸ”´ Frontend CI Failed'
          description: |
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Author:** ${{ github.actor }}
          color: 0xff0000