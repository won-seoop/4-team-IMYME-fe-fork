name: Frontend CI/CD v2

on:
  pull_request:
    branches:
      - dev
  push:
    branches:
      - dev

permissions:
  actions: write
  contents: read

concurrency:
  group: frontend-cicd-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # 1) CI
  ci:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Node.js ì„¤ì •
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. pnpm ì„¤ì¹˜
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      # 4. pnpm ìºì‹œ
      - name: Cache pnpm
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      # 5. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: Install dependencies
        run: pnpm install

      # 6. ì •ì  ë¶„ì„ (ì—ëŸ¬ ë¡œê·¸ ìº¡ì²˜)
      - name: Run ESLint
        id: lint
        continue-on-error: true
        run: |
          mkdir -p error-logs
          pnpm lint 2>&1 | tee error-logs/lint.log
          exit ${PIPESTATUS[0]}

      - name: Run Prettier
        id: prettier
        continue-on-error: true
        run: |
          pnpm prettier --check . 2>&1 | tee error-logs/prettier.log
          exit ${PIPESTATUS[0]}

      # 7. íƒ€ì… ì²´í¬
      - name: Type Check
        id: typecheck
        continue-on-error: true
        run: |
          pnpm tsc --noEmit 2>&1 | tee error-logs/typecheck.log
          exit ${PIPESTATUS[0]}

      # ì—ëŸ¬ ë¡œê·¸ ì—…ë¡œë“œ (ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ)
      - name: Upload error logs
        if: steps.lint.outcome == 'failure' || steps.prettier.outcome == 'failure' || steps.typecheck.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: error-logs
          path: error-logs/
          retention-days: 1

      # ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ CI ì‹¤íŒ¨ ì²˜ë¦¬
      - name: Check for failures
        if: steps.lint.outcome == 'failure' || steps.prettier.outcome == 'failure' || steps.typecheck.outcome == 'failure'
        run: |
          echo "âŒ CI checks failed:"
          [ "${{ steps.lint.outcome }}" == "failure" ] && echo "  - ESLint failed"
          [ "${{ steps.prettier.outcome }}" == "failure" ] && echo "  - Prettier failed"
          [ "${{ steps.typecheck.outcome }}" == "failure" ] && echo "  - TypeScript failed"
          exit 1

      # 8. ë¹Œë“œ
      - name: Build
        env:
          NEXT_PUBLIC_KAKAO_REST_API_KEY: ${{ secrets.NEXT_PUBLIC_KAKAO_REST_API_KEY }}
          NEXT_PUBLIC_KAKAO_REDIRECT_URI: ${{ secrets.NEXT_PUBLIC_DEV_KAKAO_REDIRECT_URI }}
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_DEV_API_BASE_URL }}
          NEXT_PUBLIC_SECURE: ${{ secrets.NEXT_PUBLIC_DEV_SECURE }}
          NODE_ENV: ${{ secrets.NODE_DEV_ENV }}
          NEXT_PUBLIC_SERVER_URL: ${{ secrets.NEXT_PUBLIC_DEV_SERVER_URL }}
          NEXT_PUBLIC_GOOGLE_ANALYTICS: ${{ secrets.NEXT_PUBLIC_DEV_GOOGLE_ANALYTICS }}

        run: |
          echo "=== Build env check (masked) ==="
          echo "NODE_ENV=$NODE_ENV"
          echo "NEXT_PUBLIC_SERVER_URL=$NEXT_PUBLIC_SERVER_URL"
          echo "NEXT_PUBLIC_API_BASE_URL=$NEXT_PUBLIC_API_BASE_URL"
          echo "NEXT_PUBLIC_SECURE=$NEXT_PUBLIC_SECURE"
          echo "NEXT_PUBLIC_KAKAO_REDIRECT_URI=$NEXT_PUBLIC_KAKAO_REDIRECT_URI"
          echo "NEXT_PUBLIC_GOOGLE_ANALYTICS=$NEXT_PUBLIC_GOOGLE_ANALYTICS"

          pnpm next build

      # 9. ì´ì „ ì•„í‹°íŒ©íŠ¸ ì‚­ì œ
      - name: Delete old artifacts
        if: github.ref == 'refs/heads/dev' || github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          script: |
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name === 'frontend-dev-latest') {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                });
              }
            }

      # 10. ë°°í¬ìš© íŒŒì¼ ì¤€ë¹„
      - name: Prepare deployment files
        if: github.ref == 'refs/heads/dev' || github.event.pull_request.merged == true
        run: |
          mkdir -p deploy
          cp -r .next deploy/
          cp -r public deploy/ || true
          cp package.json deploy/
          cp pnpm-lock.yaml deploy/

      # 11. ë¹Œë“œ ê²°ê³¼ ì—…ë¡œë“œ
      - name: Upload artifact
        if: github.ref == 'refs/heads/dev' || github.event.pull_request.merged == true
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dev-latest
          path: deploy/
          retention-days: 15
          overwrite: true
          include-hidden-files: true

  ci-notify-success:
    needs: ci
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Discord CI success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: 'ğŸŸ¢ Frontend CI Success'
          content: '<@&${{ secrets.FRONTEND_ROLE_ID }}> í”„ë¡ íŠ¸ì—”ë“œ CI ì„±ê³µ!'
          color: 0x00ff00

  ci-notify-failure:
    needs: ci
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Download error logs
        uses: actions/download-artifact@v4
        with:
          name: error-logs
          path: error-logs/
        continue-on-error: true

      - name: Prepare error message
        id: error_msg
        run: |
          ERROR_MSG=""

          if [ -f error-logs/lint.log ]; then
            LINT_ERRORS=$(grep -E "warning|error" error-logs/lint.log | head -20 || true)
            if [ -n "$LINT_ERRORS" ]; then
              ERROR_MSG="${ERROR_MSG}ğŸ“‹ **ESLint:**\n\`\`\`\n${LINT_ERRORS}\n\`\`\`\n"
            fi
          fi

          if [ -f error-logs/prettier.log ]; then
            PRETTIER_ERRORS=$(grep -E "^\[warn\]|Code style issues" error-logs/prettier.log | head -20 || true)
            if [ -n "$PRETTIER_ERRORS" ]; then
              ERROR_MSG="${ERROR_MSG}ğŸ¨ **Prettier:**\n\`\`\`\n${PRETTIER_ERRORS}\n\`\`\`\n"
            fi
          fi

          if [ -f error-logs/typecheck.log ]; then
            TSC_ERRORS=$(grep -E "error TS|\.tsx?\(" error-logs/typecheck.log | head -20 || true)
            if [ -n "$TSC_ERRORS" ]; then
              ERROR_MSG="${ERROR_MSG}ğŸ“ **TypeScript:**\n\`\`\`\n${TSC_ERRORS}\n\`\`\`\n"
            fi
          fi

          if [ -z "$ERROR_MSG" ]; then
            ERROR_MSG="ë¹Œë“œ ë˜ëŠ” ê¸°íƒ€ ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
          fi

          # GitHub Actions outputì— ì €ì¥ (ë©€í‹°ë¼ì¸)
          echo "msg<<EOF" >> $GITHUB_OUTPUT
          echo -e "$ERROR_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Discord CI failure
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: 'ğŸ”´ Frontend CI Failed'
          content: '<@&${{ secrets.FRONTEND_ROLE_ID }}> í”„ë¡ íŠ¸ì—”ë“œ CI ì‹¤íŒ¨!'
          description: ${{ steps.error_msg.outputs.msg }}
          color: 0xff0000

  # 2) CD
  cd:
    needs: ci
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest

    steps:
      # 0ï¸âƒ£ Runner IP íšë“ ë° ë³´ì•ˆ ê·¸ë£¹ ì¶”ê°€
      - name: Get Runner IP
        id: ip
        run: echo "ipv4=$(curl -s https://api.ipify.org)" >> $GITHUB_OUTPUT

      - name: Add IP to Security Group
        run: |
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr "${{ steps.ip.outputs.ipv4 }}/32"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2

      # 1. SSH ì„¤ì •
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts

      # 2. ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download frontend artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dev-latest
          path: ./frontend-build

      # 3. ì„œë²„ ì „ì†¡ (ì••ì¶•í•´ì„œ ë¹ ë¥´ê²Œ)
      - name: Copy artifact to dev server
        run: |
          tar -czf frontend-build.tar.gz -C ./frontend-build .
          scp -i ~/.ssh/id_rsa frontend-build.tar.gz ubuntu@${{ secrets.DEV_SERVER_HOST }}:/home/ubuntu/mine/frontend/
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.DEV_SERVER_HOST }} 'rm -rf /home/ubuntu/mine/frontend/build/* && tar -xzf /home/ubuntu/mine/frontend/frontend-build.tar.gz -C /home/ubuntu/mine/frontend/build && rm /home/ubuntu/mine/frontend/frontend-build.tar.gz'

      # 4. ë°°í¬ (release/current êµ¬ì¡°)
      - name: Deploy to Dev Server
        run: |
          ssh -i ~/.ssh/id_rsa ubuntu@${{ secrets.DEV_SERVER_HOST }} 'bash -s' <<'EOF'
          set -e

          APP_DIR=/home/ubuntu/mine/frontend
          RELEASES_DIR=$APP_DIR/releases
          SHARED_DIR=$APP_DIR/shared
          RELEASE_ID=$(date +%Y%m%d%H%M%S)

          CURRENT_LINK=$APP_DIR/current
          RELEASE_DIR=$RELEASES_DIR/$RELEASE_ID

          mkdir -p "$RELEASE_DIR"

          # 1. ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë³µì‚¬ (.next, package.json, pnpm-lock.yaml)
          cp -r $APP_DIR/build/.next "$RELEASE_DIR/"
          cp -r $APP_DIR/build/public "$RELEASE_DIR/"
          cp $APP_DIR/build/package.json "$RELEASE_DIR/"
          cp $APP_DIR/build/pnpm-lock.yaml "$RELEASE_DIR/"

          # 2. ì˜ì¡´ì„± ì„¤ì¹˜
          cd "$RELEASE_DIR"
          pnpm install --prod --ignore-scripts --force


          # 3. current ì‹¬ë³¼ë¦­ ë§í¬ êµì²´
          rm -rf "$CURRENT_LINK"
          ln -s "$RELEASE_DIR" "$CURRENT_LINK"

          # 4. ì´ì „ release 3ê°œë§Œ ìœ ì§€
          ls -1dt "$RELEASES_DIR"/* | tail -n +4 | xargs -r rm -rf

          # 5. PM2ë¡œ í”„ë¡ íŠ¸ ì„œë²„ ì¬ì‹œì‘
          cd "$CURRENT_LINK"

          # shared env ë¡œë“œ (ì—†ìœ¼ë©´ ì‹¤íŒ¨í•˜ê²Œ)
          ENV_FILE="$SHARED_DIR/.env"
          if [ ! -f "$ENV_FILE" ]; then
            echo "âŒ env file not found: $ENV_FILE"
            exit 1
          fi

          # envë¥¼ export ìƒíƒœë¡œ ë¡œë“œ
          set -a
          source "$ENV_FILE"
          set +a

          pm2 delete frontend || true
          pm2 start "npx next start -p 3000" \
            --name frontend \
            --time

          # 6. Health Check
          echo "ğŸ” Frontend health check"
          for i in {1..10}; do
            if curl -sf http://127.0.0.1:3000/api/health > /dev/null; then
              echo "âœ… Frontend health check passed"
              break
            fi
            echo "â³ Waiting for frontend..."
            sleep 3
          done

          if ! curl -sf http://127.0.0.1:3000/api/health > /dev/null; then
            echo "âŒ Frontend health check failed"
            pm2 logs frontend --lines 50
            exit 1
          fi


          EOF

      # 5. ë°°í¬ í›„ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
      - name: Post-deploy Smoke Test
        run: |
          set -euo pipefail

          BASE_URL="${{ secrets.DEV_BASE_URL }}"

          echo "ğŸ” Smoke 1) Health check: ${BASE_URL}/api/health"
          curl -fsS "${BASE_URL}/api/health" >/dev/null

          echo "ğŸ” Smoke 2) Main page (follow redirect) : ${BASE_URL}/"
          curl -fsSL -o /tmp/home.html "${BASE_URL}/" >/dev/null

          # HTMLì¸ì§€ ìµœì†Œ í™•ì¸(502/JSON/ë¦¬ë‹¤ì´ë ‰íŠ¸ ë£¨í”„ ê°™ì€ ê²½ìš° ê±¸ëŸ¬ëƒ„)
          grep -qi "<html" /tmp/home.html || {
            echo "âŒ Main page is not HTML"
            head -n 40 /tmp/home.html || true
            exit 1
          }

          echo "âœ… Frontend smoke tests passed"

      # 6. ë³´ì•ˆ ê·¸ë£¹ì—ì„œ IP ì œê±° (í•­ìƒ ì‹¤í–‰)
      - name: Remove IP from Security Group
        if: always()
        run: |
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.AWS_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr "${{ steps.ip.outputs.ipv4 }}/32"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ap-northeast-2

  cd-notify-success:
    needs: cd
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Discord CD success
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: success
          title: 'ğŸŸ¢ Frontend Deploy Success'
          content: 'í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ ì„œë²„ ë°°í¬ ì™„ë£Œ!'
          color: 0x00ff00

  cd-notify-failure:
    needs: cd
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Discord CD failure
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: failure
          title: 'ğŸ”´ Frontend Deploy Failed'
          content: '<@&${{ secrets.FRONTEND_ROLE_ID }}> í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œ ì„œí¬ ë°°í¬ ì‹¤íŒ¨!'
          color: 0xff0000
